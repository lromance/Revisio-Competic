<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Conexi√≥n - Asistent TIC</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #0056b3; }
        pre { background: #f8f9fa; padding: 15px; border-radius: 5px; overflow-x: auto; }
        .loading { display: none; }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 2s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Test de Conexi√≥n - Asistent TIC</h1>
        <p>Esta p√°gina te ayudar√° a diagnosticar los problemas de conexi√≥n con Google Sheets.</p>
        
        <div id="config-status" class="status warning">
            ‚ö†Ô∏è <strong>Paso 1:</strong> Configura tu API Key de Google Sheets abajo
        </div>
        
        <div style="margin: 20px 0;">
            <label for="apiKeyInput"><strong>Tu API Key de Google Sheets:</strong></label><br>
            <input type="text" id="apiKeyInput" placeholder="Pega aqu√≠ tu API Key de Google Sheets" style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px;">
            <small>Esta API Key solo se usa para esta prueba y no se guarda en ning√∫n lugar.</small>
        </div>
        
        <button onclick="testConnection()">üß™ Probar Conexi√≥n</button>
        <button onclick="testDirectAPI()">‚ö° Test Directo (sin gapi.js)</button>
        <button onclick="testAuth()">üîê Probar Autenticaci√≥n</button>
        <button onclick="clearResults()">üóëÔ∏è Limpiar Resultados</button>
        
        <div id="loading" class="loading status info">
            <div class="spinner"></div>Probando conexi√≥n...
        </div>
        
        <div id="results"></div>
        
        <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee;">
            <h3>üìã Instrucciones para crear la API Key:</h3>
            <ol>
                <li><strong>Ve a Google Cloud Console:</strong> <a href="https://console.cloud.google.com/" target="_blank">https://console.cloud.google.com/</a></li>
                <li><strong>Crea/selecciona un proyecto</strong></li>
                <li><strong>Habilita Google Sheets API:</strong> APIs y servicios ‚Üí Biblioteca ‚Üí Buscar "Google Sheets API" ‚Üí Habilitar</li>
                <li><strong>Crea API Key:</strong> APIs y servicios ‚Üí Credenciales ‚Üí + CREAR CREDENCIALES ‚Üí Clave de API</li>
                <li><strong>Configura restricciones:</strong>
                    <ul>
                        <li>Restricciones de sitio web: <code>https://lromance.github.io/*</code></li>
                        <li>Restricciones de API: Solo "Google Sheets API"</li>
                    </ul>
                </li>
            </ol>
        </div>
    </div>

    <script>
        // Configuraci√≥n
        const GOOGLE_CLIENT_ID = '267258615325-q44v579iv43lrbvrcjv5old76muvv5h8.apps.googleusercontent.com';
        const SPREADSHEET_ID = '1QUiBsT60icEUKDzsUteIp-nPDTVhCeKda_oCjH3WnEQ';
        const SHEET_NAMES = {
            STUDENTS: 'LlistaAlumnes',
            VOCABULARY: 'VocabulariTIC',
            DAILY_TOPIC: 'ContingutsDiari',
            NOTES: 'NotesAlumnes'
        };

        let gapi;
        let gapiReady = false;

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        function addResult(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.innerHTML = message;
            results.appendChild(div);
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        function updateConfigStatus() {
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            const configStatus = document.getElementById('config-status');
            
            if (apiKey) {
                configStatus.className = 'status success';
                configStatus.innerHTML = '‚úÖ <strong>Paso 1 completado:</strong> API Key configurada';
            } else {
                configStatus.className = 'status warning';
                configStatus.innerHTML = '‚ö†Ô∏è <strong>Paso 1:</strong> Configura tu API Key de Google Sheets abajo';
            }
        }

        document.getElementById('apiKeyInput').addEventListener('input', updateConfigStatus);

        // Cargar Google API con timeout y m√°s logging
        function loadGoogleAPI() {
            return new Promise((resolve, reject) => {
                const timeout = setTimeout(() => {
                    reject(new Error('Timeout: La API de Google tard√≥ m√°s de 30 segundos en cargar'));
                }, 30000);

                if (window.gapi) {
                    addResult('‚úÖ Google API ya estaba cargada', 'success');
                    clearTimeout(timeout);
                    resolve();
                    return;
                }
                
                addResult('üîÑ Descargando script de Google API...', 'info');
                
                window.handleClientLoad = function() {
                    addResult('‚úÖ Script de Google API descargado', 'success');
                    addResult('üîÑ Inicializando m√≥dulos client y auth2...', 'info');
                    
                    window.gapi.load('client:auth2', async () => {
                        try {
                            gapi = window.gapi;
                            gapiReady = true;
                            addResult('‚úÖ M√≥dulos client y auth2 cargados', 'success');
                            clearTimeout(timeout);
                            resolve();
                        } catch (error) {
                            addResult('‚ùå Error inicializando m√≥dulos: ' + error.message, 'error');
                            clearTimeout(timeout);
                            reject(error);
                        }
                    });
                };
                
                const script = document.createElement('script');
                script.src = 'https://apis.google.com/js/api.js?onload=handleClientLoad';
                script.onload = () => {
                    addResult('üì¶ Script tag cargado correctamente', 'info');
                };
                script.onerror = (error) => {
                    addResult('‚ùå Error descargando script de Google API', 'error');
                    clearTimeout(timeout);
                    reject(new Error('No se pudo cargar la API de Google'));
                };
                document.head.appendChild(script);
            });
        }

        async function testConnection() {
            clearResults();
            showLoading(true);
            
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            
            if (!apiKey) {
                addResult('‚ùå Por favor, introduce tu API Key de Google Sheets', 'error');
                showLoading(false);
                return;
            }
            
            // Validar formato b√°sico de API Key
            if (!apiKey.startsWith('AIza') || apiKey.length < 35) {
                addResult('‚ö†Ô∏è El formato de la API Key parece incorrecto. Deber√≠a empezar con "AIza" y tener ~39 caracteres', 'warning');
            }
            
            try {
                // Paso 1: Cargar Google API
                addResult('üîÑ Paso 1: Cargando Google API...', 'info');
                await loadGoogleAPI();
                
                // Paso 2: Inicializar cliente con m√°s logging
                addResult('üîÑ Paso 2: Inicializando cliente Google Sheets...', 'info');
                addResult(`üîë Usando API Key: ${apiKey.substring(0, 8)}...${apiKey.substring(apiKey.length - 4)}`, 'info');
                
                const initStart = Date.now();
                await gapi.client.init({
                    apiKey: apiKey,
                    discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"],
                });
                const initTime = Date.now() - initStart;
                addResult(`‚úÖ Cliente Google Sheets inicializado (${initTime}ms)`, 'success');
                
                // Paso 3: Test simple primero
                addResult('üîÑ Paso 3: Probando acceso b√°sico al spreadsheet...', 'info');
                const testStart = Date.now();
                
                try {
                    const basicResponse = await gapi.client.sheets.spreadsheets.get({
                        spreadsheetId: SPREADSHEET_ID,
                    });
                    const testTime = Date.now() - testStart;
                    addResult(`‚úÖ Spreadsheet accesible (${testTime}ms)`, 'success');
                    addResult(`üìä T√≠tulo: "${basicResponse.result.properties.title}"`, 'info');
                    
                    const sheetNames = basicResponse.result.sheets.map(sheet => sheet.properties.title);
                    addResult(`üìã Hojas encontradas: ${sheetNames.join(', ')}`, 'info');
                    
                    // Verificar hojas requeridas
                    const missingSheets = Object.values(SHEET_NAMES).filter(name => !sheetNames.includes(name));
                    if (missingSheets.length > 0) {
                        addResult(`‚ö†Ô∏è Hojas faltantes: ${missingSheets.join(', ')}`, 'warning');
                    }
                    
                } catch (error) {
                    const testTime = Date.now() - testStart;
                    addResult(`‚ùå Error accediendo al spreadsheet (${testTime}ms): ${error.message}`, 'error');
                    
                    if (error.status === 403) {
                        addResult('üí° Error 403: Tu API Key no tiene permisos para Google Sheets API', 'warning');
                        addResult('üîß Soluci√≥n: Ve a Google Cloud Console ‚Üí Credenciales ‚Üí Edita tu API Key ‚Üí Restricciones de API ‚Üí Selecciona "Google Sheets API"', 'info');
                    } else if (error.status === 404) {
                        addResult('üí° Error 404: El spreadsheet no existe o no es accesible', 'warning');
                        addResult('üîß Soluci√≥n: Verifica que el ID del spreadsheet sea correcto y que sea p√∫blico', 'info');
                    } else if (error.status === 400) {
                        addResult('üí° Error 400: API Key inv√°lida', 'warning');
                        addResult('üîß Soluci√≥n: Verifica que hayas copiado correctamente la API Key', 'info');
                    }
                    
                    showLoading(false);
                    return;
                }
                
                // Paso 4: Probar acceso a cada hoja espec√≠fica
                for (const [sheetType, sheetName] of Object.entries(SHEET_NAMES)) {
                    if (!basicResponse.result.sheets.find(s => s.properties.title === sheetName)) {
                        addResult(`‚è≠Ô∏è Saltando hoja "${sheetName}" (no existe)`, 'warning');
                        continue;
                    }
                    
                    try {
                        addResult(`üîÑ Probando datos de: ${sheetName}...`, 'info');
                        const dataStart = Date.now();
                        
                        const response = await gapi.client.sheets.spreadsheets.values.get({
                            spreadsheetId: SPREADSHEET_ID,
                            range: `${sheetName}!A1:Z10`,
                        });
                        
                        const dataTime = Date.now() - dataStart;
                        const values = response.result.values;
                        
                        if (values && values.length > 0) {
                            addResult(`‚úÖ "${sheetName}": ${values.length} filas (${dataTime}ms)`, 'success');
                            addResult(`üìã Columnas: ${values[0].join(', ')}`, 'info');
                            
                            if (values.length > 1) {
                                addResult(`üìù Ejemplo fila 2: ${values[1].slice(0, 3).join(' | ')}${values[1].length > 3 ? '...' : ''}`, 'info');
                            }
                        } else {
                            addResult(`‚ö†Ô∏è "${sheetName}": Accesible pero sin datos (${dataTime}ms)`, 'warning');
                        }
                        
                    } catch (error) {
                        addResult(`‚ùå Error en "${sheetName}": ${error.message}`, 'error');
                    }
                }
                
                addResult('üéâ Test de conexi√≥n completado exitosamente', 'success');
                
            } catch (error) {
                addResult('‚ùå Error general durante el test: ' + error.message, 'error');
                console.error('Error completo:', error);
                
                // Informaci√≥n adicional para debugging
                addResult('üîç Informaci√≥n de debugging:', 'info');
                addResult(`- Navigator: ${navigator.userAgent}`, 'info');
                addResult(`- URL actual: ${window.location.href}`, 'info');
                addResult(`- Protocolo: ${window.location.protocol}`, 'info');
            }
            
            showLoading(false);
        }

        // Test directo usando fetch (alternativa a gapi.js)
        async function testDirectAPI() {
            clearResults();
            showLoading(true);
            
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            
            if (!apiKey) {
                addResult('‚ùå Por favor, introduce tu API Key de Google Sheets', 'error');
                showLoading(false);
                return;
            }
            
            try {
                addResult('üöÄ Usando m√©todo directo con fetch() - evitando gapi.js', 'info');
                
                // Test 1: Informaci√≥n b√°sica del spreadsheet
                addResult('üîÑ Obteniendo informaci√≥n del spreadsheet...', 'info');
                const metadataUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}?key=${apiKey}`;
                
                const metadataResponse = await fetch(metadataUrl);
                
                if (!metadataResponse.ok) {
                    const errorData = await metadataResponse.json();
                    throw new Error(`HTTP ${metadataResponse.status}: ${errorData.error?.message || 'Error desconocido'}`);
                }
                
                const metadata = await metadataResponse.json();
                addResult('‚úÖ Spreadsheet accesible', 'success');
                addResult(`üìä T√≠tulo: "${metadata.properties.title}"`, 'info');
                
                const sheetNames = metadata.sheets.map(sheet => sheet.properties.title);
                addResult(`üìã Hojas: ${sheetNames.join(', ')}`, 'info');
                
                // Test 2: Datos de cada hoja
                for (const [sheetType, sheetName] of Object.entries(SHEET_NAMES)) {
                    if (!sheetNames.includes(sheetName)) {
                        addResult(`‚è≠Ô∏è Saltando "${sheetName}" (no existe)`, 'warning');
                        continue;
                    }
                    
                    try {
                        addResult(`üîÑ Leyendo datos de: ${sheetName}...`, 'info');
                        const dataUrl = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${encodeURIComponent(sheetName)}!A1:Z10?key=${apiKey}`;
                        
                        const dataResponse = await fetch(dataUrl);
                        
                        if (!dataResponse.ok) {
                            const errorData = await dataResponse.json();
                            throw new Error(`HTTP ${dataResponse.status}: ${errorData.error?.message || 'Error desconocido'}`);
                        }
                        
                        const data = await dataResponse.json();
                        const values = data.values || [];
                        
                        if (values.length > 0) {
                            addResult(`‚úÖ "${sheetName}": ${values.length} filas`, 'success');
                            addResult(`üìã Columnas: ${values[0].join(', ')}`, 'info');
                            
                            if (values.length > 1) {
                                addResult(`üìù Ejemplo: ${values[1].slice(0, 3).join(' | ')}`, 'info');
                            }
                        } else {
                            addResult(`‚ö†Ô∏è "${sheetName}": Sin datos`, 'warning');
                        }
                        
                    } catch (error) {
                        addResult(`‚ùå Error en "${sheetName}": ${error.message}`, 'error');
                    }
                }
                
                addResult('üéâ Test directo completado exitosamente', 'success');
                addResult('üí° Si este test funciona, el problema est√° en gapi.js. Usa fetch() en lugar de gapi en tu app.', 'info');
                
            } catch (error) {
                addResult('‚ùå Error en test directo: ' + error.message, 'error');
                
                if (error.message.includes('403')) {
                    addResult('üí° Error 403: API Key sin permisos o restricciones mal configuradas', 'warning');
                } else if (error.message.includes('400')) {
                    addResult('üí° Error 400: API Key inv√°lida', 'warning');
                } else if (error.message.includes('404')) {
                    addResult('üí° Error 404: Spreadsheet no encontrado o sin permisos', 'warning');
                }
            }
            
            showLoading(false);
        }
        
        async function testAuth() {
            clearResults();
            showLoading(true);
            
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            
            if (!apiKey) {
                addResult('‚ùå Por favor, introduce tu API Key primero', 'error');
                showLoading(false);
                return;
            }
            
            try {
                // Cargar y configurar Google API si no est√° lista
                if (!gapiReady) {
                    await loadGoogleAPI();
                    await gapi.client.init({
                        apiKey: apiKey,
                        discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"],
                    });
                }
                
                addResult('üîÑ Inicializando autenticaci√≥n OAuth...', 'info');
                
                // Inicializar auth2
                const auth2 = gapi.auth2.init({
                    client_id: GOOGLE_CLIENT_ID,
                    scope: 'https://www.googleapis.com/auth/spreadsheets'
                });
                
                addResult('‚úÖ OAuth inicializado', 'success');
                
                // Verificar estado de autenticaci√≥n
                const authInstance = gapi.auth2.getAuthInstance();
                if (authInstance.isSignedIn.get()) {
                    addResult('‚úÖ Usuario ya autenticado', 'success');
                    const user = authInstance.currentUser.get();
                    const profile = user.getBasicProfile();
                    addResult(`üë§ Usuario: ${profile.getName()} (${profile.getEmail()})`, 'info');
                } else {
                    addResult('‚ÑπÔ∏è Usuario no autenticado. Iniciando proceso de login...', 'info');
                    const user = await authInstance.signIn();
                    const profile = user.getBasicProfile();
                    addResult(`‚úÖ Autenticaci√≥n exitosa: ${profile.getName()} (${profile.getEmail()})`, 'success');
                }
                
            } catch (error) {
                addResult('‚ùå Error en autenticaci√≥n: ' + error.message, 'error');
                if (error.error === 'popup_blocked_by_browser') {
                    addResult('üí° El navegador bloque√≥ la ventana popup. Permite popups para este sitio.', 'warning');
                }
            }
            
            showLoading(false);
        }

        // Auto-cargar Google API al cargar la p√°gina
        window.addEventListener('load', () => {
            addResult('üöÄ P√°gina cargada. Listo para probar la conexi√≥n.', 'info');
            updateConfigStatus(); // Actualizar el estado inicial de la API Key
        });
    </script>
</body>
</html>
