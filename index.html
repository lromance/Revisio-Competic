<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Conexi√≥n - Asistent TIC</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #0056b3; }
        pre { background: #f8f9fa; padding: 15px; border-radius: 5px; overflow-x: auto; }
        .loading { display: none; }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 2s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Test de Conexi√≥n - Asistent TIC</h1>
        <p>Esta p√°gina te ayudar√° a diagnosticar los problemas de conexi√≥n con Google Sheets.</p>
        
        <div id="config-status" class="status warning">
            ‚ö†Ô∏è <strong>Paso 1:</strong> Configura tu API Key de Google Sheets abajo
        </div>
        
        <div style="margin: 20px 0;">
            <label for="apiKeyInput"><strong>Tu API Key de Google Sheets:</strong></label><br>
            <input type="text" id="apiKeyInput" placeholder="Pega aqu√≠ tu API Key de Google Sheets" style="width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px;">
            <small>Esta API Key solo se usa para esta prueba y no se guarda en ning√∫n lugar.</small>
        </div>
        
        <button onclick="testConnection()">üß™ Probar Conexi√≥n</button>
        <button onclick="testAuth()">üîê Probar Autenticaci√≥n</button>
        <button onclick="clearResults()">üóëÔ∏è Limpiar Resultados</button>
        
        <div id="loading" class="loading status info">
            <div class="spinner"></div>Probando conexi√≥n...
        </div>
        
        <div id="results"></div>
        
        <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #eee;">
            <h3>üìã Instrucciones para crear la API Key:</h3>
            <ol>
                <li><strong>Ve a Google Cloud Console:</strong> <a href="https://console.cloud.google.com/" target="_blank">https://console.cloud.google.com/</a></li>
                <li><strong>Crea/selecciona un proyecto</strong></li>
                <li><strong>Habilita Google Sheets API:</strong> APIs y servicios ‚Üí Biblioteca ‚Üí Buscar "Google Sheets API" ‚Üí Habilitar</li>
                <li><strong>Crea API Key:</strong> APIs y servicios ‚Üí Credenciales ‚Üí + CREAR CREDENCIALES ‚Üí Clave de API</li>
                <li><strong>Configura restricciones:</strong>
                    <ul>
                        <li>Restricciones de sitio web: <code>https://lromance.github.io/*</code></li>
                        <li>Restricciones de API: Solo "Google Sheets API"</li>
                    </ul>
                </li>
            </ol>
        </div>
    </div>

    <script>
        // Configuraci√≥n
        const GOOGLE_CLIENT_ID = '267258615325-q44v579iv43lrbvrcjv5old76muvv5h8.apps.googleusercontent.com';
        const SPREADSHEET_ID = '1QUiBsT60icEUKDzsUteIp-nPDTVhCeKda_oCjH3WnEQ';
        const SHEET_NAMES = {
            STUDENTS: 'LlistaAlumnes',
            VOCABULARY: 'VocabulariTIC',
            DAILY_TOPIC: 'ContingutsDiari',
            NOTES: 'NotesAlumnes'
        };

        let gapi;
        let gapiReady = false;

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        function addResult(message, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.innerHTML = message;
            results.appendChild(div);
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        function updateConfigStatus() {
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            const configStatus = document.getElementById('config-status');
            
            if (apiKey) {
                configStatus.className = 'status success';
                configStatus.innerHTML = '‚úÖ <strong>Paso 1 completado:</strong> API Key configurada';
            } else {
                configStatus.className = 'status warning';
                configStatus.innerHTML = '‚ö†Ô∏è <strong>Paso 1:</strong> Configura tu API Key de Google Sheets abajo';
            }
        }

        document.getElementById('apiKeyInput').addEventListener('input', updateConfigStatus);

        // Cargar Google API
        function loadGoogleAPI() {
            return new Promise((resolve, reject) => {
                if (window.gapi) {
                    resolve();
                    return;
                }
                
                window.handleClientLoad = function() {
                    window.gapi.load('client:auth2', async () => {
                        try {
                            gapi = window.gapi;
                            gapiReady = true;
                            addResult('‚úÖ Google API cargada correctamente', 'success');
                            resolve();
                        } catch (error) {
                            addResult('‚ùå Error cargando Google API: ' + error.message, 'error');
                            reject(error);
                        }
                    });
                };
                
                const script = document.createElement('script');
                script.src = 'https://apis.google.com/js/api.js?onload=handleClientLoad';
                script.onerror = () => reject(new Error('No se pudo cargar la API de Google'));
                document.head.appendChild(script);
            });
        }

        async function testConnection() {
            clearResults();
            showLoading(true);
            
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            
            if (!apiKey) {
                addResult('‚ùå Por favor, introduce tu API Key de Google Sheets', 'error');
                showLoading(false);
                return;
            }
            
            try {
                // Paso 1: Cargar Google API
                addResult('üîÑ Paso 1: Cargando Google API...', 'info');
                await loadGoogleAPI();
                
                // Paso 2: Inicializar cliente
                addResult('üîÑ Paso 2: Inicializando cliente Google Sheets...', 'info');
                await gapi.client.init({
                    apiKey: apiKey,
                    discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"],
                });
                addResult('‚úÖ Cliente Google Sheets inicializado', 'success');
                
                // Paso 3: Probar acceso a cada hoja
                for (const [sheetType, sheetName] of Object.entries(SHEET_NAMES)) {
                    try {
                        addResult(`üîÑ Probando acceso a hoja: ${sheetName}...`, 'info');
                        const response = await gapi.client.sheets.spreadsheets.values.get({
                            spreadsheetId: SPREADSHEET_ID,
                            range: `${sheetName}!A1:Z10`, // Primeras 10 filas de todas las columnas
                        });
                        
                        const values = response.result.values;
                        if (values && values.length > 0) {
                            addResult(`‚úÖ Hoja "${sheetName}": ${values.length} filas encontradas`, 'success');
                            addResult(`üìã Encabezados: ${values[0].join(', ')}`, 'info');
                        } else {
                            addResult(`‚ö†Ô∏è Hoja "${sheetName}": Accesible pero vac√≠a`, 'warning');
                        }
                    } catch (error) {
                        addResult(`‚ùå Error accediendo a hoja "${sheetName}": ${error.message}`, 'error');
                        if (error.status === 404) {
                            addResult(`üí° Sugerencia: La hoja "${sheetName}" no existe. Verifica el nombre.`, 'warning');
                        } else if (error.status === 403) {
                            addResult(`üí° Sugerencia: Sin permisos para "${sheetName}". Verifica que la hoja sea p√∫blica o que tengas acceso.`, 'warning');
                        }
                    }
                }
                
                addResult('üéâ Test de conexi√≥n completado', 'success');
                
            } catch (error) {
                addResult('‚ùå Error durante el test: ' + error.message, 'error');
                if (error.message.includes('403')) {
                    addResult('üí° Error 403: Verifica que tu API Key tenga permisos para Google Sheets API', 'warning');
                } else if (error.message.includes('400')) {
                    addResult('üí° Error 400: Verifica que tu API Key sea v√°lida', 'warning');
                }
            }
            
            showLoading(false);
        }

        async function testAuth() {
            clearResults();
            showLoading(true);
            
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            
            if (!apiKey) {
                addResult('‚ùå Por favor, introduce tu API Key primero', 'error');
                showLoading(false);
                return;
            }
            
            try {
                // Cargar y configurar Google API si no est√° lista
                if (!gapiReady) {
                    await loadGoogleAPI();
                    await gapi.client.init({
                        apiKey: apiKey,
                        discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"],
                    });
                }
                
                addResult('üîÑ Inicializando autenticaci√≥n OAuth...', 'info');
                
                // Inicializar auth2
                const auth2 = gapi.auth2.init({
                    client_id: GOOGLE_CLIENT_ID,
                    scope: 'https://www.googleapis.com/auth/spreadsheets'
                });
                
                addResult('‚úÖ OAuth inicializado', 'success');
                
                // Verificar estado de autenticaci√≥n
                const authInstance = gapi.auth2.getAuthInstance();
                if (authInstance.isSignedIn.get()) {
                    addResult('‚úÖ Usuario ya autenticado', 'success');
                    const user = authInstance.currentUser.get();
                    const profile = user.getBasicProfile();
                    addResult(`üë§ Usuario: ${profile.getName()} (${profile.getEmail()})`, 'info');
                } else {
                    addResult('‚ÑπÔ∏è Usuario no autenticado. Iniciando proceso de login...', 'info');
                    const user = await authInstance.signIn();
                    const profile = user.getBasicProfile();
                    addResult(`‚úÖ Autenticaci√≥n exitosa: ${profile.getName()} (${profile.getEmail()})`, 'success');
                }
                
            } catch (error) {
                addResult('‚ùå Error en autenticaci√≥n: ' + error.message, 'error');
                if (error.error === 'popup_blocked_by_browser') {
                    addResult('üí° El navegador bloque√≥ la ventana popup. Permite popups para este sitio.', 'warning');
                }
            }
            
            showLoading(false);
        }

        // Auto-cargar Google API al cargar la p√°gina
        window.addEventListener('load', () => {
            addResult('üöÄ P√°gina cargada. Listo para probar la conexi√≥n.', 'info');
        });
    </script>
</body>
</html>
